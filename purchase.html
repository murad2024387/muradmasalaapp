<!DOCTYPE html>
<html lang="sd" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مراد مسالا - خريداري</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Purchase specific styles */
        .purchase-section {
            margin: 20px;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .invoice-meta {
            display: flex;
            gap: 20px;
        }
        
        .meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .meta-item label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .supplier-info {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .purchase-items {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .add-item-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .add-item-row .form-group {
            flex: 1;
            min-width: 150px;
        }
        
        .item-list table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .item-list th, .item-list td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }
        
        .item-list th {
            background: #f8f9fa;
        }
        
        .calculation-fields {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .calculation-fields .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .total-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1em;
        }
        
        .grand-total {
            font-weight: bold;
            font-size: 1.3em;
            color: #e67e22;
            border-top: 2px solid #e67e22;
            padding-top: 10px;
        }
        
        .btn-remove {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .select2-container--default .select2-selection--single {
            height: 38px;
            border: 1px solid #ced4da;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-pepper-hot"></i>
            <span>مراد مسالا</span>
        </div>
        
        <button class="menu-toggle" onclick="toggleMenu()" style="background: transparent; border: none; cursor: pointer;">
            <svg width="30" height="30" viewBox="0 0 30 30" fill="#2C3E50" xmlns="http://www.w3.org/2000/svg">
                <rect y="6" width="30" height="3" rx="1.5" />
                <rect y="13" width="30" height="3" rx="1.5" />
                <rect y="20" width="30" height="3" rx="1.5" />
            </svg>
        </button>
        
        <nav id="mainNav">
            <div class="nav-category">
                <a href="index.html" class="nav-btn">
                    <i class="fas fa-home"></i>
                    <span>ڊش بورڊ</span>
                </a>
                <a href="products.html" class="nav-btn">
                    <i class="fas fa-boxes"></i>
                    <span>پراڊڪٽس</span>
                </a>
                <a href="purchase.html" class="nav-btn active">
                    <i class="fas fa-cart-plus"></i>
                    <span>خريداري</span>
                </a>
            </div>
        </nav>
    </header>

    <main>
        <section class="purchase-section">
            <div class="section-header">
                <h2><i class="fas fa-cart-plus"></i> نئين خريداري</h2>
            </div>
            
            <div class="invoice-header">
                <div class="invoice-meta">
                    <div class="meta-item">
                        <label>انوائس نمبر</label>
                        <span id="invoiceNo">INV-${Date.now().toString().slice(-6)}</span>
                    </div>
                    <div class="meta-item">
                        <label>تاريخ</label>
                        <span id="invoiceDate">${new Date().toLocaleDateString('sd')}</span>
                    </div>
                </div>
                <div class="invoice-meta">
                    <div class="meta-item">
                        <label for="invoiceType">انوائس قسم</label>
                        <select id="invoiceType" style="width: 120px;">
                            <option value="purchase">خريداري</option>
                            <option value="quotation">قيمت</option>
                            <option value="return">واپسي</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="supplier-info">
                <h3><i class="fas fa-truck"></i> سپلائر معلومات</h3>
                <div class="form-row">
                    <div class="form-group" style="flex-grow: 2;">
                        <label for="supplierSelect">سپلائر*</label>
                        <select id="supplierSelect" class="supplier-search" required>
                            <option value="">-- سپلائر چونڊيو --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>باقي رقم</label>
                        <span id="supplierBalance" style="display: block; padding: 8px 0;">₹0.00</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="supplierPhone">فون نمبر</label>
                        <input type="tel" id="supplierPhone" readonly>
                    </div>
                    <div class="form-group">
                        <label for="paymentType">ادائيگي جو طريقو</label>
                        <select id="paymentType">
                            <option value="cash">نقد</option>
                            <option value="credit">ڪريڊٽ</option>
                            <option value="bank">بئنڪ</option>
                            <option value="cheque">چيڪ</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="supplierAddress">پتو</label>
                    <textarea id="supplierAddress" rows="2" readonly></textarea>
                </div>
            </div>
            
            <div class="purchase-items">
                <h3><i class="fas fa-box-open"></i> خريداري جون شيون</h3>
                
                <div class="add-item-row">
                    <div class="form-group" style="flex-grow: 2;">
                        <label for="productSelect">پراڊڪٽ*</label>
                        <select id="productSelect" class="product-search" required>
                            <option value="">-- پراڊڪٽ ڳوليو --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="itemPack">پيڪ سائيز</label>
                        <input type="text" id="itemPack" readonly>
                    </div>
                    <div class="form-group">
                        <label for="itemPrice">قيمت</label>
                        <input type="number" id="itemPrice" readonly>
                    </div>
                    <div class="form-group">
                        <label for="itemQuantity">مقدار*</label>
                        <input type="number" id="itemQuantity" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="itemTotal">ڪل رقم</label>
                        <input type="number" id="itemTotal" readonly>
                    </div>
                    <button class="btn btn-primary" id="addItemBtn" style="align-self: flex-end;">
                        <i class="fas fa-plus"></i> شامل ڪريو
                    </button>
                </div>
                
                <div class="item-list">
                    <table id="purchaseItemsTable">
                        <thead>
                            <tr>
                                <th width="5%">نمبر</th>
                                <th width="30%">شيون</th>
                                <th width="10%">قيمت</th>
                                <th width="15%">مقدار</th>
                                <th width="10%">پيڪ</th>
                                <th width="15%">ڪل رقم</th>
                                <th width="15%">عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Items will be added here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="calculation-fields">
                    <div class="form-group">
                        <label for="totalItems">ڪل شيون</label>
                        <input type="number" id="totalItems" readonly>
                    </div>
                    <div class="form-group">
                        <label for="billAmount">بل رقم</label>
                        <input type="number" id="billAmount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="discount">ڊسڪائونٽ</label>
                        <input type="number" id="discount" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="additionalCharges">اضافي لاڳت</label>
                        <input type="number" id="additionalCharges" value="0" min="0">
                    </div>
                </div>
                
                <div class="total-summary">
                    <div class="total-row">
                        <span>بل رقم:</span>
                        <span id="subTotal">₹0.00</span>
                    </div>
                    <div class="total-row">
                        <span>ڊسڪائونٽ:</span>
                        <span id="discountAmount">₹0.00</span>
                    </div>
                    <div class="total-row">
                        <span>اضافي لاڳت:</span>
                        <span id="additionalAmount">₹0.00</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>ڪل رقم:</span>
                        <span id="grandTotal">₹0.00</span>
                    </div>
                    <div class="total-row">
                        <span>ادا ڪيل رقم:</span>
                        <input type="number" id="paidAmount" value="0" min="0">
                    </div>
                    <div class="total-row">
                        <span>باقي رقم:</span>
                        <span id="balanceAmount">₹0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="invoiceNote">نوٽ</label>
                <textarea id="invoiceNote" rows="2"></textarea>
            </div>
            
            <div class="form-actions" style="text-align: left;">
                <button class="btn btn-success" id="savePurchaseBtn">
                    <i class="fas fa-save"></i> محفوظ ڪريو
                </button>
                <button class="btn btn-primary" id="printInvoiceBtn">
                    <i class="fas fa-print"></i> پرنٽ ڪريو
                </button>
                <button class="btn btn-danger" id="cancelPurchaseBtn">
                    <i class="fas fa-times"></i> منسوخ ڪريو
                </button>
            </div>
        </section>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Purchase Management System
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Select2 for searchable dropdowns
            $('.supplier-search').select2();
            $('.product-search').select2();
            
            // Generate random invoice number
            function generateInvoiceNo() {
                const prefix = document.getElementById('invoiceType').value === 'quotation' ? 'QTN' : 
                              document.getElementById('invoiceType').value === 'return' ? 'RTN' : 'INV';
                const randomNum = Math.floor(100000 + Math.random() * 900000);
                return `${prefix}-${randomNum}`;
            }
            
            // Load suppliers into select dropdown
            function loadSuppliers() {
                const suppliers = getSuppliers();
                const select = $('#supplierSelect');
                
                select.empty().append('<option value="">-- سپلائر چونڊيو --</option>');
                
                suppliers.forEach(supplier => {
                    select.append(new Option(
                        `${supplier.name} (${supplier.phone}) - ₹${supplier.balance.toFixed(2)}`,
                        supplier.id,
                        false,
                        false
                    ));
                });
                
                // Trigger change to update supplier info
                select.trigger('change');
            }
            
            // Load products into select dropdown
            function loadProducts() {
                const products = getProducts();
                const select = $('#productSelect');
                
                select.empty().append('<option value="">-- پراڊڪٽ ڳوليو --</option>');
                
                products.forEach(product => {
                    select.append(new Option(
                        `${product.name} (${product.stock} ${getUnitName(product.unit)} باقي)`,
                        product.id,
                        false,
                        false
                    ));
                });
            }
            
            // Helper function to get suppliers from localStorage
            function getSuppliers() {
                const suppliers = localStorage.getItem('muradMasalaSuppliers');
                return suppliers ? JSON.parse(suppliers) : [
                    {
                        id: 1,
                        name: 'عامر سپلائرز',
                        phone: '03001234567',
                        address: 'حيدرآباد، سنڌ',
                        balance: 15000
                    },
                    {
                        id: 2,
                        name: 'مراد مسالا ڪمپني',
                        phone: '03129876543',
                        address: 'ڪراچي، سنڌ',
                        balance: 5000
                    }
                ];
            }
            
            // Helper function to get products from localStorage
            function getProducts() {
                const products = localStorage.getItem('muradMasalaProducts');
                return products ? JSON.parse(products) : [];
            }
            
            // Helper function to get unit name
            function getUnitName(unit) {
                const units = {
                    'kg': 'ڪلو',
                    'g': 'گرام',
                    'packet': 'پيڪٽ',
                    'piece': 'ٽڪرو'
                };
                return units[unit] || unit;
            }
            
            // Array to hold purchase items
            let purchaseItems = [];
            
            // Update supplier info when selected
            $('#supplierSelect').on('change', function() {
                const supplierId = $(this).val();
                const suppliers = getSuppliers();
                const supplier = suppliers.find(s => s.id == supplierId);
                
                if (supplier) {
                    $('#supplierPhone').val(supplier.phone);
                    $('#supplierAddress').val(supplier.address);
                    $('#supplierBalance').text(`₹${supplier.balance.toFixed(2)}`);
                } else {
                    $('#supplierPhone').val('');
                    $('#supplierAddress').val('');
                    $('#supplierBalance').text('₹0.00');
                }
            });
            
            // Update product info when selected
            $('#productSelect').on('change', function() {
                const productId = $(this).val();
                const products = getProducts();
                const product = products.find(p => p.id == productId);
                
                if (product) {
                    $('#itemPack').val(getUnitName(product.unit));
                    $('#itemPrice').val(product.cost || product.price * 0.8);
                    $('#itemQuantity').val(1);
                    calculateItemTotal();
                } else {
                    $('#itemPack').val('');
                    $('#itemPrice').val('');
                    $('#itemQuantity').val(1);
                    $('#itemTotal').val('');
                }
            });
            
            // Calculate item total when quantity changes
            $('#itemQuantity').on('input', calculateItemTotal);
            
            function calculateItemTotal() {
                const quantity = parseFloat($('#itemQuantity').val()) || 0;
                const price = parseFloat($('#itemPrice').val()) || 0;
                $('#itemTotal').val((quantity * price).toFixed(2));
            }
            
            // Add item to purchase list
            $('#addItemBtn').click(function() {
                const productId = $('#productSelect').val();
                const productText = $('#productSelect option:selected').text().split(' (')[0];
                const quantity = parseFloat($('#itemQuantity').val());
                const unitPrice = parseFloat($('#itemPrice').val());
                const packSize = $('#itemPack').val();
                
                if (!productId || isNaN(quantity) || isNaN(unitPrice)) {
                    alert('مهرباني ڪري سڀ ضروري معلومات داخل ڪريو');
                    return;
                }
                
                const totalPrice = quantity * unitPrice;
                
                // Add to purchase items array
                purchaseItems.push({
                    productId,
                    name: productText,
                    quantity,
                    unit: packSize,
                    unitPrice,
                    totalPrice
                });
                
                // Update the items table
                updateItemsTable();
                
                // Reset the form
                $('#productSelect').val('').trigger('change');
                $('#itemQuantity').val(1);
                calculateItemTotal();
            });
            
            // Update the items table
            function updateItemsTable() {
                const tbody = $('#purchaseItemsTable tbody');
                tbody.empty();
                
                let subTotal = 0;
                let totalItems = 0;
                
                purchaseItems.forEach((item, index) => {
                    tbody.append(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name}</td>
                            <td>₹${item.unitPrice.toFixed(2)}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td>₹${item.totalPrice.toFixed(2)}</td>
                            <td>
                                <button class="btn-remove" onclick="removeItem(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                    
                    subTotal += item.totalPrice;
                    totalItems += item.quantity;
                });
                
                // Update summary fields
                $('#totalItems').val(totalItems);
                $('#billAmount').val(subTotal.toFixed(2));
                
                // Calculate totals
                const discount = parseFloat($('#discount').val()) || 0;
                const additionalCharges = parseFloat($('#additionalCharges').val()) || 0;
                const grandTotal = subTotal - discount + additionalCharges;
                const paidAmount = parseFloat($('#paidAmount').val()) || 0;
                const balance = grandTotal - paidAmount;
                
                // Update summary
                $('#subTotal').text(`₹${subTotal.toFixed(2)}`);
                $('#discountAmount').text(`₹${discount.toFixed(2)}`);
                $('#additionalAmount').text(`₹${additionalCharges.toFixed(2)}`);
                $('#grandTotal').text(`₹${grandTotal.toFixed(2)}`);
                $('#balanceAmount').text(`₹${balance.toFixed(2)}`);
            }
            
            // Remove item from purchase list
            window.removeItem = function(index) {
                purchaseItems.splice(index, 1);
                updateItemsTable();
            };
            
            // Update totals when discount or additional charges change
            $('#discount, #additionalCharges, #paidAmount').on('input', updateItemsTable);
            
            // Save purchase to localStorage
            $('#savePurchaseBtn').click(function() {
                const supplierId = $('#supplierSelect').val();
                const supplierName = $('#supplierSelect option:selected').text().split(' (')[0];
                
                if (!supplierId || purchaseItems.length === 0) {
                    alert('مهرباني ڪري سپلائر ۽ گهٽ ۾ گهٽ هڪ شين جي خريداري داخل ڪريو');
                    return;
                }
                
                // Calculate totals
                const subTotal = parseFloat($('#billAmount').val()) || 0;
                const discount = parseFloat($('#discount').val()) || 0;
                const additionalCharges = parseFloat($('#additionalCharges').val()) || 0;
                const grandTotal = subTotal - discount + additionalCharges;
                const paidAmount = parseFloat($('#paidAmount').val()) || 0;
                const balance = grandTotal - paidAmount;
                
                // Create purchase object
                const purchase = {
                    id: generateInvoiceNo(),
                    date: new Date().toISOString(),
                    type: $('#invoiceType').val(),
                    supplier: {
                        id: supplierId,
                        name: supplierName,
                        phone: $('#supplierPhone').val(),
                        address: $('#supplierAddress').val()
                    },
                    paymentType: $('#paymentType').val(),
                    items: purchaseItems,
                    subTotal: subTotal,
                    discount: discount,
                    additionalCharges: additionalCharges,
                    grandTotal: grandTotal,
                    paidAmount: paidAmount,
                    balance: balance,
                    note: $('#invoiceNote').val()
                };
                
                // Save to localStorage
                const purchases = JSON.parse(localStorage.getItem('muradMasalaPurchases') || '[]');
                purchases.push(purchase);
                localStorage.setItem('muradMasalaPurchases', JSON.stringify(purchases));
                
                // Update supplier balance if credit
                if ($('#paymentType').val() === 'credit') {
                    const suppliers = getSuppliers();
                    const supplierIndex = suppliers.findIndex(s => s.id == supplierId);
                    if (supplierIndex !== -1) {
                        suppliers[supplierIndex].balance += balance;
                        localStorage.setItem('muradMasalaSuppliers', JSON.stringify(suppliers));
                    }
                }
                
                // Update product stocks
                purchaseItems.forEach(item => {
                    updateProductStock(item.productId, item.quantity, 
                        purchase.type === 'return' ? 'subtract' : 'add', 
                        `${purchase.type === 'return' ? 'واپسي' : 'خريداري'} #${purchase.id}`);
                });
                
                alert('انوائس کامیابي سان محفوظ ٿي وئي آهي!');
                resetPurchaseForm();
            });
            
            // Update product stock
            function updateProductStock(productId, quantity, action = 'add', notes = '') {
                const products = getProducts();
                const productIndex = products.findIndex(p => p.id == productId);
                
                if (productIndex !== -1) {
                    if (action === 'add') {
                        products[productIndex].stock += quantity;
                    } else if (action === 'subtract') {
                        products[productIndex].stock = Math.max(0, products[productIndex].stock - quantity);
                    }
                    
                    // Save updated products
                    localStorage.setItem('muradMasalaProducts', JSON.stringify(products));
                    return true;
                }
                return false;
            }
            
            // Reset purchase form
            function resetPurchaseForm() {
                $('#invoiceNo').text(generateInvoiceNo());
                $('#invoiceDate').text(new Date().toLocaleDateString('sd'));
                $('#supplierSelect').val('').trigger('change');
                $('#paymentType').val('cash');
                purchaseItems = [];
                updateItemsTable();
                $('#discount').val(0);
                $('#additionalCharges').val(0);
                $('#paidAmount').val(0);
                $('#invoiceNote').val('');
            }
            
            // Print invoice
            $('#printInvoiceBtn').click(function() {
                alert('پرنٽ ڪرڻ جي خاصيت اڃا تياري ۾ آهي');
                // Implement print functionality here
            });
            
            // Cancel purchase
            $('#cancelPurchaseBtn').click(function() {
                if (confirm('ڇا توهان پڪ آهيو ته توهان هن انوائس کي منسوخ ڪرڻ چاهيو ٿا؟')) {
                    resetPurchaseForm();
                }
            });
            
            // Change invoice number when type changes
            $('#invoiceType').change(function() {
                $('#invoiceNo').text(generateInvoiceNo());
            });
            
            // Initialize the page
            loadSuppliers();
            loadProducts();
            resetPurchaseForm();
        });
        
        // Menu toggle function
        function toggleMenu() {
            const nav = document.getElementById('mainNav');
            nav.style.display = nav.style.display === 'none' ? 'block' : 'none';
        }
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مراد مسالا - خريداري</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Purchase specific styles */
        .purchase-section {
            margin: 20px;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .invoice-meta {
            display: flex;
            gap: 20px;
        }
        
        .meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .meta-item label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .supplier-info {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .purchase-items {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .add-item-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .add-item-row .form-group {
            flex: 1;
            min-width: 150px;
        }
        
        .item-list table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .item-list th, .item-list td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }
        
        .item-list th {
            background: #f8f9fa;
        }
        
        .calculation-fields {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .calculation-fields .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .total-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1em;
        }
        
        .grand-total {
            font-weight: bold;
            font-size: 1.3em;
            color: #e67e22;
            border-top: 2px solid #e67e22;
            padding-top: 10px;
        }
        
        .btn-remove {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .select2-container--default .select2-selection--single {
            height: 38px;
            border: 1px solid #ced4da;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }
        
        /* Invoice View Modal */
        .invoice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow: auto;
        }
        
        .invoice-modal-content {
            background: white;
            margin: 2% auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        .invoice-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .invoice-modal-body {
            margin-bottom: 20px;
        }
        
        .invoice-search {
            margin-bottom: 20px;
        }
        
        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-invoice, .printable-invoice * {
                visibility: visible;
            }
            .printable-invoice {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>


    <!-- Main Purchase Interface (same as before) -->
    <main>
        <section class="purchase-section">
            <!-- Previous purchase form content remains the same -->
            <!-- ... -->
            
            <!-- Add View Invoices Button -->
            <div class="form-actions" style="text-align: left; margin-top: 20px;">
                <button class="btn btn-info" id="viewInvoicesBtn">
                    <i class="fas fa-list"></i> انوائس ڏسو
                </button>
            </div>
        </section>
    </main>

    <!-- Invoice View Modal -->
    <div id="invoiceModal" class="invoice-modal">
        <div class="invoice-modal-content">
            <div class="invoice-modal-header">
                <h3><i class="fas fa-file-invoice"></i> انوائس فهرست</h3>
                <span class="close" onclick="closeInvoiceModal()">&times;</span>
            </div>
            
            <div class="invoice-search">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="invoiceSearch" placeholder="انوائس ڳوليو...">
                </div>
                <div class="filters" style="margin-top: 10px;">
                    <select id="invoiceTypeFilter">
                        <option value="">سڀ قسمون</option>
                        <option value="purchase">خريداري</option>
                        <option value="quotation">قيمت</option>
                        <option value="return">واپسي</option>
                    </select>
                    <input type="date" id="invoiceDateFilter">
                </div>
            </div>
            
            <div class="invoice-modal-body">
                <div class="table-responsive">
                    <table id="invoicesTable">
                        <thead>
                            <tr>
                                <th>انوائس نمبر</th>
                                <th>تاريخ</th>
                                <th>قسم</th>
                                <th>سپلائر</th>
                                <th>ڪل رقم</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Invoices will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Printable Invoice -->
    <div id="printableInvoice" class="printable-invoice" style="display: none;">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2>مراد مسالا</h2>
            <p>مسالن جي دڪان، حيدرآباد</p>
            <p>فون: 03001234567</p>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <div>
                <p><strong>انوائس نمبر:</strong> <span id="printInvoiceNo"></span></p>
                <p><strong>تاريخ:</strong> <span id="printInvoiceDate"></span></p>
            </div>
            <div>
                <p><strong>قسم:</strong> <span id="printInvoiceType"></span></p>
                <p><strong>ادائيگي:</strong> <span id="printPaymentType"></span></p>
            </div>
        </div>
        
        <div style="margin-bottom: 10px;">
            <p><strong>سپلائر:</strong> <span id="printSupplierName"></span></p>
            <p><strong>فون:</strong> <span id="printSupplierPhone"></span></p>
            <p><strong>پتو:</strong> <span id="printSupplierAddress"></span></p>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="padding: 8px; border: 1px solid #ddd;">نمبر</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">شيون</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">قيمت</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">مقدار</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">پيڪ</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">ڪل رقم</th>
                </tr>
            </thead>
            <tbody id="printItemsTable">
                <!-- Items will be added here -->
            </tbody>
        </table>
        
        <div style="margin-left: auto; width: 300px;">
            <div style="display: flex; justify-content: space-between;">
                <span>بل رقم:</span>
                <span id="printSubTotal"></span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>ڊسڪائونٽ:</span>
                <span id="printDiscount"></span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>اضافي لاڳت:</span>
                <span id="printAdditional"></span>
            </div>
            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2em; margin-top: 10px; border-top: 1px solid #000; padding-top: 5px;">
                <span>ڪل رقم:</span>
                <span id="printGrandTotal"></span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                <span>ادا ڪيل رقم:</span>
                <span id="printPaid"></span>
            </div>
            <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px; border-top: 1px solid #000; padding-top: 5px;">
                <span>باقي رقم:</span>
                <span id="printBalance"></span>
            </div>
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <p>مهرباني ڪري وري گهمي آيو!</p>
            <p>_________________________</p>
            <p>مھرباني</p>
        </div>
        
        <div style="margin-top: 20px;">
            <p><strong>نوٽ:</strong> <span id="printNote"></span></p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Enhanced Purchase Management System
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Select2 for searchable dropdowns
            $('.supplier-search').select2();
            $('.product-search').select2();
            
            // Generate random invoice number
            function generateInvoiceNo() {
                const prefix = document.getElementById('invoiceType').value === 'quotation' ? 'QTN' : 
                              document.getElementById('invoiceType').value === 'return' ? 'RTN' : 'INV';
                const randomNum = Math.floor(100000 + Math.random() * 900000);
                return `${prefix}-${randomNum}`;
            }
            
            // Convert units (gram to kg, etc.)
            function convertUnit(quantity, fromUnit, toUnit) {
                if (fromUnit === 'g' && toUnit === 'kg') {
                    return quantity / 1000;
                } else if (fromUnit === 'kg' && toUnit === 'g') {
                    return quantity * 1000;
                }
                return quantity;
            }
            
            // Load suppliers into select dropdown
            function loadSuppliers() {
                const suppliers = getSuppliers();
                const select = $('#supplierSelect');
                
                select.empty().append('<option value="">-- سپلائر چونڊيو --</option>');
                
                suppliers.forEach(supplier => {
                    select.append(new Option(
                        `${supplier.name} (${supplier.phone}) - ₹${supplier.balance.toFixed(2)}`,
                        supplier.id,
                        false,
                        false
                    ));
                });
                
                // Trigger change to update supplier info
                select.trigger('change');
            }
            
            // Load products into select dropdown with unit conversion
            function loadProducts() {
                const products = getProducts();
                const select = $('#productSelect');
                
                select.empty().append('<option value="">-- پراڊڪٽ ڳوليو --</option>');
                
                products.forEach(product => {
                    // Convert stock to different units for display
                    let displayStock = product.stock;
                    let displayUnit = product.unit;
                    
                    if (product.unit === 'g' && product.stock >= 1000) {
                        displayStock = (product.stock / 1000).toFixed(3);
                        displayUnit = 'kg';
                    }
                    
                    select.append(new Option(
                        `${product.name} (${displayStock} ${getUnitName(displayUnit)} باقي)`,
                        product.id,
                        false,
                        false
                    ));
                });
            }
            
            // View Invoices Button
            $('#viewInvoicesBtn').click(function() {
                openInvoiceModal();
                loadInvoices();
            });
            
            // Open Invoice Modal
            function openInvoiceModal() {
                $('#invoiceModal').show();
            }
            
            // Close Invoice Modal
            window.closeInvoiceModal = function() {
                $('#invoiceModal').hide();
            }
            
            // Load invoices into table
            function loadInvoices() {
                const invoices = getInvoices();
                const tbody = $('#invoicesTable tbody');
                tbody.empty();
                
                if (invoices.length === 0) {
                    tbody.append('<tr><td colspan="6" style="text-align:center;">ڪوبه انوائس مليو نه</td></tr>');
                    return;
                }
                
                invoices.forEach(invoice => {
                    tbody.append(`
                        <tr>
                            <td>${invoice.id}</td>
                            <td>${new Date(invoice.date).toLocaleDateString('sd')}</td>
                            <td>${getInvoiceTypeName(invoice.type)}</td>
                            <td>${invoice.supplier.name}</td>
                            <td>₹${invoice.grandTotal.toFixed(2)}</td>
                            <td>
                                <button class="btn-action btn-view" onclick="viewInvoice('${invoice.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action btn-print" onclick="printInvoice('${invoice.id}')">
                                    <i class="fas fa-print"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });
            }
            
            // View invoice details
            window.viewInvoice = function(invoiceId) {
                const invoices = getInvoices();
                const invoice = invoices.find(i => i.id === invoiceId);
                
                if (invoice) {
                    alert(`انوائس تفصيل:\n
نمبر: ${invoice.id}\n
تاريخ: ${new Date(invoice.date).toLocaleDateString('sd')}\n
سپلائر: ${invoice.supplier.name}\n
ڪل رقم: ₹${invoice.grandTotal.toFixed(2)}`);
                }
            };
            
            // Print invoice
            window.printInvoice = function(invoiceId) {
                const invoices = getInvoices();
                const invoice = invoices.find(i => i.id === invoiceId);
                
                if (invoice) {
                    // Populate printable invoice
                    $('#printInvoiceNo').text(invoice.id);
                    $('#printInvoiceDate').text(new Date(invoice.date).toLocaleDateString('sd'));
                    $('#printInvoiceType').text(getInvoiceTypeName(invoice.type));
                    $('#printPaymentType').text(getPaymentTypeName(invoice.paymentType));
                    $('#printSupplierName').text(invoice.supplier.name);
                    $('#printSupplierPhone').text(invoice.supplier.phone);
                    $('#printSupplierAddress').text(invoice.supplier.address);
                    
                    // Populate items
                    const itemsTable = $('#printItemsTable');
                    itemsTable.empty();
                    
                    invoice.items.forEach((item, index) => {
                        itemsTable.append(`
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">₹${item.unitPrice.toFixed(2)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${item.quantity}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${item.unit}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">₹${item.totalPrice.toFixed(2)}</td>
                            </tr>
                        `);
                    });
                    
                    // Populate totals
                    $('#printSubTotal').text(`₹${invoice.subTotal.toFixed(2)}`);
                    $('#printDiscount').text(`₹${invoice.discount.toFixed(2)}`);
                    $('#printAdditional').text(`₹${invoice.additionalCharges.toFixed(2)}`);
                    $('#printGrandTotal').text(`₹${invoice.grandTotal.toFixed(2)}`);
                    $('#printPaid').text(`₹${invoice.paidAmount.toFixed(2)}`);
                    $('#printBalance').text(`₹${invoice.balance.toFixed(2)}`);
                    $('#printNote').text(invoice.note || 'ڪو نوٽ نه');
                    
                    // Show and print
                    $('#printableInvoice').show();
                    window.print();
                    $('#printableInvoice').hide();
                }
            };
            
            // Helper functions
            function getInvoiceTypeName(type) {
                const types = {
                    'purchase': 'خريداري',
                    'quotation': 'قيمت',
                    'return': 'واپسي'
                };
                return types[type] || type;
            }
            
            function getPaymentTypeName(type) {
                const types = {
                    'cash': 'نقد',
                    'credit': 'ڪريڊٽ',
                    'bank': 'بئنڪ',
                    'cheque': 'چيڪ'
                };
                return types[type] || type;
            }
            
            function getInvoices() {
                const invoices = localStorage.getItem('muradMasalaPurchases');
                return invoices ? JSON.parse(invoices) : [];
            }
            
            // Rest of your existing purchase system code remains the same
            // ...
            
            // Initialize the page
            loadSuppliers();
            loadProducts();
            resetPurchaseForm();
        });
        
        // Menu toggle function
        function toggleMenu() {
            const nav = document.getElementById('mainNav');
            nav.style.display = nav.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>


</html>